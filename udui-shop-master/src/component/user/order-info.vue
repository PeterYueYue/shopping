<style scoped>

    /* line 2, ../sass/ie.scss */

    .order-info-box div {
        background: #fff;
        padding: 0 0.18rem;
        text-align: left;
    }

    /* line 3, ../sass/ie.scss */

    .order-info-box .order-state {
        height: 1.1rem;
        margin-bottom: 0.18rem;
    }

    /* line 5, ../sass/ie.scss */

    .order-info-box .order-state p {
        font-size: 0.3rem;
        color: #ff833e;
        line-height: 1.1rem;
        text-align: left;
    }

    /* line 7, ../sass/ie.scss */

    .order-info-box .add-info {
        padding: 0.32rem 0.18rem 0.3rem;
        margin-bottom: 0.18rem;
    }

    /* line 9, ../sass/ie.scss */

    .order-info-box .add-info .add-name {
        padding-left: 0.46rem;
        color: #333333;
        font-size: 0.3rem;
        margin-bottom: 0.24rem;
    }

    /* line 11, ../sass/ie.scss */

    .order-info-box .add-info .add-name span {
        padding-left: 0.54rem;
    }

    /* line 13, ../sass/ie.scss */

    .order-info-box .add-info .adds {
        font-size: 0.26rem;
        color: #666666;
    }

    /* line 15, ../sass/ie.scss */

    .order-info-box .add-info .adds .icon-position {
        padding: 0 0.23rem;
        background: url("../../../src/assets/images/icn/icon-position.png") center center no-repeat;
        background-size: 0.21rem 0.27rem;
    }

    /* line 18, ../sass/ie.scss */

    .order-info-box .order-detail {
        background: #f7f7f7;
        overflow: hidden;
    }

    /* line 20, ../sass/ie.scss */

    .order-info-box .order-detail .pro-tit {
        color: #333333;
        font-size: 0.28rem;
        line-height: 0.74rem;
        background: #fff;
        margin: 0 -0.18rem;
        padding-left: 0.18rem;
    }

    /* line 21, ../sass/ie.scss */

    .order-info-box .order-detail dl {
        padding: 0.18rem 0;
        overflow: hidden;
        border-bottom: 0.01rem solid #e5e5e5;
        background: #f7f7f7;
        border-bottom:1px solid #ccc;
    }

    /* line 23, ../sass/ie.scss */

    .order-info-box .order-detail dl dd {
        float: left;
        width: 1.63rem;
        height: 1.63rem;
        margin-right: 0.16rem;
    }

    /* line 25, ../sass/ie.scss */

    .order-info-box .order-detail dl dd img {
        display: block;
        width: 100%;
        height: 100%;
    }

    /* line 27, ../sass/ie.scss */

    .order-info-box .order-detail dl dt {
        text-align: left;
        font-size: 0.23rem;
        color: #000;
        overflow: hidden;
    }

    /* line 28, ../sass/ie.scss */

    .order-info-box .order-detail dl .proName {
        padding-top: 0.08rem;
        padding-bottom: 0.12rem;
    }

    /* line 30, ../sass/ie.scss */

    .order-info-box .order-detail dl .proName p {
        line-height: 0.3rem;
        height: 0.6rem;
    }

    /* line 32, ../sass/ie.scss */

    .order-info-box .order-detail dl .proAttribute {
        color: #999999;
        height: 0.65rem;
    }

    /* line 35, ../sass/ie.scss */

    .order-info-box .order-detail dl .proPrice {
        line-height: 0.3rem;
    }

    /* line 37, ../sass/ie.scss */

    .order-info-box .order-detail dl .proPrice .proNum {
        float: right;
    }

    /* line 40, ../sass/ie.scss */

    .order-info-box .order-detail a.linkBtn {
        margin: 0.2rem 0;
        padding: 0 0.18rem;
        border-radius: 0.06rem;
        float: right;
        line-height: 0.5rem;
        font-size: 0.26rem;
        color: #333;
        border: 1px solid #333;
        margin-left: 0.2rem;
    }
    .order-info-box .order-detail a.linkBtn.yellow-btn{
        background-color:#ff833e;
        color:white;
        border:1px solid #ff833e;
    }
    .order-info-box .order-detail a.linkBtn.red-btn{
        background-color:#FF2772;
        color:white;
        border:1px solid #FF2772;
    }

        /* line 42, ../sass/ie.scss */

    .order-info-box .pro-info {
        margin-bottom: 0.18rem;
    }

    /* line 43, ../sass/ie.scss */

    .order-info-box table {
        width: 100%;
        font-size: 0.28rem;
        line-height: 0.42rem;
        padding: 0.2rem 0;
    }

    .order-info-box table th {
        font-weight: normal;
    }

    /* line 47, ../sass/ie.scss */

    .order-info-box table tr td {
        text-align: right;
        color: #ff2772;
    }

    /* line 50, ../sass/ie.scss */

    .order-info-box .order-info {
        padding: 0.2rem 0.18rem;
    }

    /* line 52, ../sass/ie.scss */

    .order-info-box .order-info p {
        font-size: 0.26rem;
        line-height: 0.4rem;
        text-align: right;
    }

    .order-info-box .order-info p span {
        float: left;
    }

    .btns {
        height: 1rem;
        border-top: 1px solid #ccc;
    }

    .btns a {
        color: #333;
        float: right;
        padding: 0.15rem 0.3rem;
        border-radius: 0.05rem;
        border: 1px solid #333;
        margin-top: 0.2rem;
        margin-left: 0.2rem;
    }

    .store-sub-model {
        width: 100%;
        margin-top: 0.2rem;
        background-color: #fff;
        height: 0.8rem;
        line-height: 0.8rem;
        font-size: 0.28rem;
    }

    .store-sub-model i {
        width: 0.24rem;
        height: 0.6rem;
        margin-top: 0.1rem;
        margin-right: 0.2rem;
        background: url(../../assets/images/store/moble-ico.png) no-repeat center;
        display: inline-block;
        float: left;
        background-size: 100%;
    }

    .tcShopInfo {
        height: 2rem;
        background-color: white;
        margin-top: 0.2rem;
        margin-bottom:0.2rem;
    }

    .tcShopInfo h3{
        padding:0 0.2rem;
        font-weight: normal;
        height:0.7rem;
        line-height: 0.7rem;
        border-bottom:1px solid #ccc;
    }
    .tcShopInfo .infoBox{margin-top:0.25rem;}
    .tcShopInfo .infoBox .shopNameAdd{
        padding:0;
        box-sizing: border-box;
        width:80%;
        float:left;
        border-right:1px solid #ccc;
    }
    .tcShopInfo .infoBox .shopNameAdd .address{color:#999; line-height: 0.5rem;}
    .tcShopInfo .infoBox .phone_img{
        box-sizing: border-box;
        width:20%;
        float:left;
        text-align: center;
        padding-top:0.1rem;
    }
    .tcShopInfo .infoBox .phone_img a{
        display: inline-block;
        width:0.6rem;
        height:0.6rem;
        background-color:red;
        background:url(../../assets/images/store/phone.png) no-repeat;
        background-size: 100%;
    }
    .tcShopInfo .infoBox .shopName{font-size: 0.26rem; color:black;}

</style>

<template>

    <div class="order-info-box">
        <loading :show="loading"></loading>
        <headnav v-bind:title="pagetitle"></headnav>
        <div class="order-state">
            <p>{{orderInfoData.state | orderState}}
            <span style="float:right;font-size: 0.24rem;" v-show="orderInfoData.state == 'WAIT_BUYER_PAY'">
                <countdown :endTime="orderInfoData.expireTime/1000" :callback="ceshi" v-if="countdownShow"></countdown>后交易自动关闭
            </span>
            </p>
        </div>
        <div class="add-info" v-if="ProductState == 'normal'">
            <p class="add-name">{{orderInfoData.receiverName}}<span>{{orderInfoData.userName}}</span></p>
            <p class="adds"><i class="icon-position"></i>{{orderInfoData.receiverArea + orderInfoData.receiverAddress}}
            </p>
        </div>
        <div class="store-sub-model" v-if="ProductState == 'tc'">
            <i></i>
            <p>{{orderInfoData.receiverMobile}}</p>
        </div>
        <div class="order-detail">
            <p class="pro-tit" v-if="ProductState == 'normal'">{{orderInfoData.sellerName}}</p>
            <dl v-for="data in orderInfoData.orderItemList">
                <dd>
                    <router-link :to="'/goodsDetail/pro/'+data.productId">
                        <img :src="data.productImgUrl">
                    </router-link>
                </dd>
                <dt class="proName">{{data.productName}}</dt>
                <dt class="proAttribute">{{data.productSpecFeachure}}</dt>
                <dt class="proPrice">¥{{data.totalPayment}} (可抵用{{data.unitVouchers}}优券)<span
                    class="proNum">x{{data.count}}</span></dt>
              <!--<router-link :to="{path:'/refundApply',query:{proId:data.productId,order:data.orderNo,orderItem:data.id,buyNum:data.count}}" class="linkBtn"-->
              <a href="javascript:;" class="linkBtn" ref="linkBtn" @click="toData($event,data)"
                   :class="item | proBtnFilter"
                   v-for="item in probtnShow(data)">{{item}}</a>
            </dl>
        </div>
        <div class="pro-info" v-if="ProductState == 'normal'">
            <table>
                <tr>
                    <th>商品金额：</th>
                    <td>￥{{(orderInfoData.totalSellerPrice + orderInfoData.totalVouchers).toFixed(2)}}</td>
                </tr>
                <tr>
                    <th>运费：</th>
                    <td>￥{{orderInfoData.totalDeliveryFee}}</td>
                </tr>
                <tr>
                    <th>活动抵扣：</th>
                    <td>-￥{{orderInfoData.totalVouchers}}</td>
                </tr>
                <tr>
                    <th>实付款：</th>
                    <td>￥{{orderInfoData.totalPay}}</td>
                </tr>
            </table>
        </div>
        <div class="tcShopInfo" v-if="ProductState == 'tc'">
            <h3>适用商户</h3>
            <div class="infoBox clearfix">
                <div class="shopNameAdd">
                    <p class="shopName">{{shopName}}</p>
                    <p class="address">{{shopAdd}}</p>
                </div>
                <div class="phone_img">
                    <a :href="'tel:'+telephone"></a>
                </div>
            </div>

        </div>
        <div class="order-info">
            <p><span>订单编号：</span>{{orderInfoData.no}}</p>
            <p><span>下单时间：</span>{{orderInfoData.createTime | formatDate}}</p>
            <p v-if="ProductState == 'tc'"><span>数量：</span>{{orderInfoData.totalCount}}</p>
            <p v-if="ProductState == 'tc'"><span>价格：</span>{{orderInfoData.totalPayment}}</p>
            <p v-if="ProductState == 'tc'"><span>实付款：</span>￥{{orderInfoData.totalSellerPrice}}+￥{{orderInfoData.totalVouchers}}优卷</p>
            <p v-if="orderInfoData.paymentTime"><span>支付时间：</span>{{orderInfoData.paymentTime | formatDate}}</p>
        </div>
        <div class="clearfix btns">
            <a style="color:#FF2772;border:1px solid #FF2772" class="" @click="ljzf" v-show="orderInfoData.state == 'WAIT_BUYER_PAY' ">立即支付</a>
            <a class="" @click="qxdd" v-show="orderInfoData.state == 'WAIT_BUYER_PAY' ">取消订单</a>
            <a style="color:#FF2772;border:1px solid #FF2772" class="" @click="qrsh(orderInfoData.no)"  v-show="orderInfoData.state == 'WAIT_BUYER_CONFIRM_GOODS'" >确认收货</a>
            <a class="" v-show="orderInfoData.state == 'TRADE_FINISHED' && orderInfoData.evaluateState ">以评价</a>
            <a class="" @click="sendComment(orderInfoData.no)" v-show="orderInfoData.state == 'TRADE_FINISHED' && !orderInfoData.evaluateState">发表评价</a>
        </div>
        <dialog-pop v-if="dialogOnOff"  v-bind:dialog="dialogConfig" v-on:off="offDialog" @dialogCancle="dialogCancle" @dialogClickOk="dialogClickOk"></dialog-pop>
        <!-- <order-list :orderList="orderList"></order-list> -->
    </div>

</template>

<script type="text/javascript">
    import {
        mapGetters
    }
        from 'vuex'
    import loading from './../common/loading.vue'
    import headnav from './../common/header.vue'
    import banner from './../common/banner.vue'
    import countdown from './../common/countdown.vue'
    import orderList from './order-list.vue'
    import dialogPop from './../common/dialog-pop.vue'
    import common from './../../../static/common'
    import {formatDate} from '../../../static/mUtils'
    const components = {
        loading, headnav, banner, orderList, countdown,dialogPop
    }
    export default {
        data() {
            return {
                pagetitle: "订单详情",   //店铺头部
                loading: false,         //动画加载显示
                probtns: [],   //商品可操作的按钮
                ProductState: '',    //商品类型
                shopName:'',
                telephone:'',
                dialogOnOff : false,
                dialogConfig : {
                    autoOff:true,
                    txt:''
                },
                countdownShow:true, //倒计时的显示
            }
        },
        computed: {
            ...mapGetters({
                orderInfoData: 'orderInfoData',
                isWx : 'isWx'
            }),
        },
        filters: {
            proBtnFilter(type){
                switch (type){
                    case '申请退款':
                        return 'yellow-btn';
                    case '申请退货':
                        return 'yellow-btn';
                    case '查看物流':
                        return 'red-btn';
                }
            },
            formatDate(time) {
                let date = new Date(time);
                return formatDate(date, 'yyyy-MM-dd hh:mm:ss');
            }
        },
        components: components,
        methods: {
            offDialog(){
                this.dialogOnOff = false;
            },
            ljzf(){
                console.log('去支付页面');
            },
            sendComment(No){
                this.$router.push('/editevaluate/no/'+No);
            },
            dialogCancle(){
                this.dialogOnOff = false;
                console.log('你点击了取消');
            },
            dialogClickOk(){
                this.dialogConfig.btn=false;
                this.dialogConfig.txt='订单已完成';
                //确认收货方法
                this.$store.dispatch('confirmReceipt',this.orderInfoData.no).then(()=>{
                    setTimeout(()=>{
                        this.dialogOnOff = false;
                        this.$router.push('/userOrders');
                    },2000)
                },(data)=>{
                    console.log(data);
                });

            },
            qrsh(No){
                this.currNo = No;
                this.dialogOnOff = true;
                this.dialogConfig.autoOff=false;
                this.dialogConfig.txt='确认收货后，无法退货退款';
                this.dialogConfig.btn=true;
                this.dialogConfig.cancle='取消';
                this.dialogConfig.ok='确认';
            },
            qxdd(){
                this.$store.dispatch('orderCancel',this.$route.params.orderNo).then(()=>{
                    this.dialogOnOff = true;
                    this.dialogConfig.txt="取消订单成功";
                    setTimeout(()=>{
                        this.$router.push('/userOrders');
                    },2000)
                });
            },
            toData(event,data){
                var target = event.target;
                switch (target.innerHTML){
                    case '退款中,仅退款':
                        this.$router.push('/refundState/oid/'+data.id);
                        break;
                    case '申请退款':
                        this.$router.push({path:'/refundApply',query:{proId:data.productId,order:data.orderNo,orderItem:data.id,buyNum:data.count}});
                        break;
                    case '退款详情':
                        this.$router.push('/refundState/oid/'+data.id);
                        break;
                    case '申请退货':
                        this.$router.push({path:'/refundApply',query:{proId:data.productId,order:data.orderNo,orderItem:data.id,buyNum:data.count}});
                        break;
                    case '查看物流':
                        this.$router.push('/viewLogistics/n/'+data.id);
                        break;
                }
            },
            ceshi(){
                this.countdownShow = false;
            },
            probtnShow(data){
                if (this.ProductState == 'normal') {
                    this.ProductState = 'normal';
                    if (data.isAfterSales) {
                        switch (data.itemState) {
                            case "WAIT_SELLER_SEND_GOODS":
                                if (data.afterSalesType === 1) {   //仅退款
                                    if (data.itemRefundStatus === 'WAIT_SELLER_AGREE') {
                                        return ['退款中,仅退款']
                                    } else if (data.itemRefundStatus === "SUCCESS") {
                                        return ['退款详情']
                                    } else if (data.itemRefundStatus === "WAIT_BUYER_RETURN_GOODS") {
                                        return ['退款中,退货']
                                    } else if (data.itemRefundStatus === "SELLER_REFUSE_BUYER") {
                                        return ['拒绝退款']
                                    } else {
                                        return ['申请退款'];
                                    }
                                } else if (data.afterSalesType === 2) {  //退款退货
                                    if (data.itemRefundStatus === "WAIT_SELLER_AGREE") {
                                        return ['退款中,退货']
                                    } else if (data.itemRefundStatus === "SUCCESS") {
                                        return ['退款详情']
                                    } else if (data.itemRefundStatus === "WAIT_BUYER_RETURN_GOODS") {
                                        return ['退款中,退货']
                                    } else if (data.itemRefundStatus === "SELLER_REFUSE_BUYER") {
                                        return ['拒绝退款']
                                    } else {
                                        return []
                                    }
                                } else {
                                    return ['申请退货'];
                                }
                            case "WAIT_BUYER_PAY":
                                return []
                            case "WAIT_BUYER_CONFIRM_GOODS":
                                if (data.afterSalesType == 1) { //仅退款
                                    if (data.itemRefundStatus == "WAIT_SELLER_AGREE") {
                                        return ['退款中,仅退款'];
                                    } else if (data.itemRefundStatus == "SUCCESS") {
                                        return ['退款详情'];
                                    } else if (data.itemRefundStatus == "WAIT_BUYER_RETURN_GOODS") {
                                        return ['退款中,退货'];
                                    } else if (data.itemRefundStatus == "SELLER_REFUSE_BUYER") {
                                        return ['拒绝退款'];
                                    } else if (data.itemRefundStatus == 'CLOSED') {
                                        return ['查看物流', '申请退款'];
                                    } else {
                                        return ['申请退款'];
                                    }
                                } else if (data.afterSalesType == 2) { //退款退货
                                    if (data.itemRefundStatus == "WAIT_SELLER_AGREE") {
                                        return ['退款中,退货'];
                                    } else if (data.itemRefundStatus == "SUCCESS") {
                                        return ['退款详情'];
                                    } else if (data.itemRefundStatus == "WAIT_BUYER_RETURN_GOODS") {
                                        return ['退款中,退货'];
                                    } else if (data.itemRefundStatus == "SELLER_REFUSE_BUYER") {
                                        return ['拒绝退款'];
                                    } else if (data.itemRefundStatus == 'CLOSED') {
                                        return ['查看物流', '申请退款'];
                                    } else {
                                        return ['申请退款'];
                                    }
                                } else {
                                    return ['查看物流', '申请退货'];
                                }
                                break;
                            case "TRADE_CLOSED_BY_UDUI":
                                return []
                            case "TRADE_FINISHED":
                                return []
                            case "TRADE_CLOSED":
                                return ['退款完成','退款详情'];
                            case "WAIT_SELLER_CONFIRM":
                                if (data.afterSalesType == 1) { //仅退款
                                    if (data.itemRefundStatus == "WAIT_SELLER_AGREE") {
                                        return ['退款中,仅退款']
                                    } else if (data.itemRefundStatus == "SUCCESS") {
                                        return ['退款详情']
                                    } else if (data.itemRefundStatus == "SELLER_REFUSE_BUYER") {
                                        return ['拒绝退款']
                                    } else {
                                        return ['申请退款']
                                    }
                                } else {
                                    return ['申请退款']
                                }
                        }
                    } else {
                        switch (data.itemState) {
                            case "WAIT_BUYER_CONFIRM_GOODS":
                                return ['查看物流']
                        }
                    }
                } else if(this.ProductState == 'tc') {
                    this.ProductState = 'tc';
                    this.shopName = this.orderInfoData.orderShopDto.name;
                    this.shopAdd = this.orderInfoData.orderShopDto.address;
                    this.telephone = this.orderInfoData.orderShopDto.telephone;
                }
            },
            showNum: function () {
                console.log(this.isLogin)
            }
        },
        created() {
            var This = this;
            let orderNo = this.$route.params.orderNo
            this.$store.dispatch('getOrderInfo', {
                orderNo: orderNo
            }).then((data)=>{
                if(data.cityFlag == 0){
                    this.ProductState = 'normal';
                }else{
                    this.ProductState = 'tc';
                }
                var view = data.orderItemList;
                var shareTitle = '我刚刚在优兑商城购买了' + view[0].productName + ',推荐你也看看';
                var url = common.processingURL.domainName + 'productDetail/proId/' + view[0].productId;
                if(This.isWx){
                    // This.$store.dispatch('wxShare',{title:shareTitle,link:url,imgUrl:})
                }
            });
        }
    }

</script>
